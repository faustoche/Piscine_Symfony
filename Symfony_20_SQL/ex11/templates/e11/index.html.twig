{% extends 'e11/base.html.twig' %}

{% block content %}

	{# Section des notifications centrées #}
	{% for label, messages in app.flashes %}
		{% for message in messages %}
			<div class="alert" style="color: {{ label == 'error' ? '#721c24' : '#155724' }}; background-color: {{ label == 'error' ? '#f8d7da' : '#d4edda' }}; border-color: {{ label == 'error' ? '#f5c6cb' : '#c3e6cb' }};">
				{{ message }}
			</div>
		{% endfor %}
	{% endfor %}

	<div class="card" style="min-width: 95%; margin-top: 20px;">
		<h2>SQL - Request with join, sort and condition</h2>

		{# --- ADMINISTRATION DE LA BASE --- #}
		<div style="margin-bottom: 30px; padding: 20px; background-color: #f0f8ff; border: 1px solid #007bff; border-radius: 8px;">
			<h3 style="margin-top: 0; color: #0056b3;">Database Administration</h3>
			<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;">
				<a href="{{ path('e11_create_table') }}" style="text-decoration: none; background: #007bff; color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
					1. Create Table
				</a>
				<a href="{{ path('e11_add_column') }}" style="text-decoration: none; background: #007bff; color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
					2. Add Column
				</a>
				<a href="{{ path('e11_create_relations') }}" style="text-decoration: none; background: #007bff; color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">
					3. Create Relations
				</a>
			</div>
		</div>

		{# --- FORMULAIRE DE FILTRE ET TRI --- #}
		<div style="margin-bottom: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
			<form method="get" action="{{ path('e11_controller_index') }}" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; justify-content: center;">
				<div style="text-align: left;">
					<label style="display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 5px;">Search Name/Username:</label>
					<input type="text" name="filter_name" value="{{ current_filter }}" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
				</div>
				
				<div style="text-align: left;">
					<label style="display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 5px;">Sort by:</label>
					<select name="sort_by" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
						<option value="p.name" {{ current_sort == 'p.name' ? 'selected' : '' }}>Name</option>
						<option value="p.birthdate" {{ current_sort == 'p.birthdate' ? 'selected' : '' }}>Birthdate</option>
						<option value="a.city" {{ current_sort == 'a.city' ? 'selected' : '' }}>City (Joined)</option>
					</select>
				</div>
				
				<div style="text-align: left;">
					<label style="display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 5px;">Order:</label>
					<select name="sort_order" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
						<option value="ASC" {{ current_order == 'ASC' ? 'selected' : '' }}>Ascending</option>
						<option value="DESC" {{ current_order == 'DESC' ? 'selected' : '' }}>Descending</option>
					</select>
				</div>
				
				<div style="display: flex; gap: 10px;">
					<button type="submit" style="background: #333; color: white; border: none; padding: 9px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Apply</button>
					<a href="{{ path('e11_controller_index') }}" style="text-decoration: none; color: #666; padding: 8px 15px; border: 1px solid #ccc; border-radius: 4px; background: white; font-size: 0.9rem;">Reset</a>
				</div>
			</form>
		</div>

		{# --- FORMULAIRE D'AJOUT --- #}
		<div style="margin-bottom: 40px; padding: 20px; border-top: 1px solid #eee;">
			<h3>Add a person</h3>
			<div class="symfony-form" style="text-align: left; max-width: 500px; margin: 0 auto;">
				{{ form_start(form) }}
					{{ form_widget(form) }}
					<div style="text-align: center; margin-top: 20px;">
						<button type="submit">Save</button>
					</div>
				{{ form_end(form) }}
			</div>
		</div>

		{# --- TABLEAU DES RÉSULTATS --- #}
		<div>
			<h3>Subscribers (Database: persons)</h3>
			<table style="width: 100%; border-collapse: collapse; margin-top: 20px; text-align: left;">
				<thead>
					<tr style="background-color: #f8f9fa;">
						<th style="padding: 12px; border: 1px solid #ddd;">ID</th>
						<th style="padding: 12px; border: 1px solid #ddd;">Username</th>
						<th style="padding: 12px; border: 1px solid #ddd;">
							<a href="{{ path('e11_controller_index', {'sort_by': 'p.name', 'sort_order': current_order == 'ASC' ? 'DESC' : 'ASC', 'filter_name': current_filter}) }}" style="text-decoration: none; color: inherit;">
								Name {{ current_sort == 'p.name' ? (current_order == 'ASC' ? '▲' : '▼') : '' }}
							</a>
						</th>
						<th style="padding: 12px; border: 1px solid #ddd;">Email</th>
						<th style="padding: 12px; border: 1px solid #ddd;">Birthdate</th>
						<th style="padding: 12px; border: 1px solid #ddd;">City</th>
						<th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for person in persons %}
						<tr>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.id }}</td>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.username }}</td>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.name }}</td>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.email }}</td>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.birthdate }}</td>
							<td style="padding: 10px; border: 1px solid #ddd;">{{ person.city ? person.city : '-' }}</td>
							<td style="padding: 10px; border: 1px solid #ddd; text-align: center; white-space: nowrap;">
								<a href="{{ path('e11_update', {id: person.id}) }}" style="color: #f59e0b; text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid #f59e0b; padding: 4px 8px; border-radius: 4px; margin-right: 5px; display: inline-block;">UPDATE</a>
								<a href="{{ path('e11_delete', {id: person.id}) }}" onclick="return confirm('Are you sure?');" style="color: #eb255aff; text-decoration: none; font-weight: bold; font-size: 0.8rem; border: 1px solid #eb255aff; padding: 4px 8px; border-radius: 4px; display: inline-block;">DELETE</a>
							</td>
						</tr>
					{% else %}
						<tr><td colspan="7" style="padding: 20px; text-align: center; border: 1px solid #ddd; color: #999;">No one found.</td></tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

	<style>
		.symfony-form div { margin-bottom: 15px; }
		.symfony-form label { display: block; font-weight: bold; margin-bottom: 5px; }
		.symfony-form input, .symfony-form select, .symfony-form textarea {
			width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
		}
		.card table a:hover { opacity: 0.7; }
	</style>

{% endblock %}